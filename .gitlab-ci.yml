services:
  - name: docker:dind
    command: ["dockerd-entrypoint.sh", "--host=unix:///var/run/docker.sock"]

stages:
  - build
  - deploy

build:
  stage: build
  image: node:latest
  script:
    - npm install
    - npm run build

deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t poj-web-app .
    - docker run --rm poj-web-app php artisan migrate --force
    - docker run --rm poj-web-app chmod -R 777 storage bootstrap/cache
    - docker run --rm poj-web-app php artisan optimize
