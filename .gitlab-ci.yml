stages:
  - deploy

Deploy:
  stage: deploy
  variables:
    VAR_DIREKTORI: "/var/www/html"
    VAR_GIT_URL_HTTPS: "https://danudenny:glpat-K9-cPQe3oCyzpySEJRjx@cicd.optimajasa.co.id/danudenny/poj-web.git"
    VAR_USER: "deployer"
    VAR_IP: "192.168.100.73"
    VAR_FILE_ENV: $FILE_ENV

  before_script:
    - apt-get update
    - apt-get install -y composer
    - |
      # Install nvm and use Node.js version 14
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # Load nvm
      nvm install 14  # Install Node.js version 14
      nvm use 14  # Set Node.js version 14 as the default
    - "which ssh-agent || ( apt-get install openssh-client )"
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p 23932 $VAR_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

  script:
    - git config --global credential.helper "store --file ~/.git-credentials"
    - echo -e "https://danudenny:glpat-K9-cPQe3oCyzpySEJRjx\n" > ~/.git-credentials
    - if [ ! -d /var/www/html ]; then git clone $VAR_GIT_URL_HTTPS /var/www/html; else cd /var/www/html && git pull origin staging; fi
    - git config user.name "Denny Danuwijaya"
    - git config user.email "danudenny@gmail.com"
    - git pull origin staging
    - rm ~/.git-credentials
    - cd $VAR_DIREKTORI && echo '$VAR_FILE_ENV' >> .env
    - composer install --ignore-platform-reqs
    - php artisan migrate
    - php artisan key:generate
    - php artisan optimize
    - npm run build
    - echo "A!"
  only:
    - tags
